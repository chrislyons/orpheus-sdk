# OCC037 - Edit Dialog Preview Enhancements (v0.2.0-alpha)

**Date:** 2025-10-22
**Status:** ✅ Implemented
**Related:** OCC034 (Waveform Rendering), OCC035 (Edit Dialog Phases 2 & 3)
**Version:** v0.2.0-alpha candidate

---

## Summary

Complete implementation of Edit Dialog preview enhancements including real-time fade audition, transport position visualization, keyboard shortcut fixes, and SDK integration infrastructure. All preview mode features now working; main playback integration deferred to SDK enhancement (Week 7-8).

---

## Context

After implementing Phases 2 & 3 of the Edit Dialog (OCC035), user testing revealed four critical usability issues:

1. **Keyboard shortcuts buggy** - I/O keys setting points to midpoint instead of playback position
2. **No fade preview** - Fade settings not audible during preview playback
3. **No transport position indicator** - Users couldn't see playback position
4. **Insufficient waveform detail** - Hard to make precise edits visually

Additionally, infrastructure was missing to apply edited metadata to main clip playback via AudioEngine/SDK integration.

---

## Implementation

### 1. Fixed I/O Keyboard Shortcuts

**Problem:** Setting IN point also moved OUT point (both converging toward midpoint)

**Root Cause:**

```cpp
// WRONG: Used midpoint calculation
int64_t midPoint = (m_metadata.trimInSamples + m_metadata.trimOutSamples) / 2;
m_metadata.trimInSamples = midPoint;
```

**Fix:**

```cpp
// CORRECT: Use current playback position
int64_t currentPos = m_previewPlayer->getCurrentPosition();
m_metadata.trimInSamples = std::clamp(currentPos, int64_t(0), m_metadata.trimOutSamples - tickInSamples);
m_previewPlayer->setTrimPoints(m_metadata.trimInSamples, m_metadata.trimOutSamples);
m_previewPlayer->play(); // Restart from new IN point
```

**Files:** `ClipEditDialog.cpp:522-551`

---

### 2. Fade Preview with Real-Time Audio Processing

**API Addition (PreviewPlayer.h:46-52):**

```cpp
void setFades(float fadeInSeconds, float fadeOutSeconds,
              const juce::String& fadeInCurve, const juce::String& fadeOutCurve);
```

**Audio Callback Implementation (PreviewPlayer.cpp:226-255):**

```cpp
// Sample-by-sample gain envelope
for (int i = 0; i < chunkSize; ++i) {
  int64_t samplePos = currentPos + i;
  int64_t relativePos = samplePos - trimIn;
  float gain = 1.0f;

  // Fade-in (first N samples from trim IN)
  if (fadeInSamples > 0 && relativePos < fadeInSamples) {
    float fadeInPos = static_cast<float>(relativePos) / fadeInSamples;
    gain *= calculateFadeGain(fadeInPos, m_fadeInCurve);
  }

  // Fade-out (last N samples before trim OUT)
  if (fadeOutSamples > 0 && relativePos >= (trimmedDuration - fadeOutSamples)) {
    int64_t fadeOutRelPos = relativePos - (trimmedDuration - fadeOutSamples);
    float fadeOutPos = static_cast<float>(fadeOutRelPos) / fadeOutSamples;
    gain *= (1.0f - calculateFadeGain(fadeOutPos, m_fadeOutCurve));
  }

  // Apply gain to all output channels
  for (int ch = 0; ch < numOutputChannels; ++ch) {
    outputChannelData[ch][destOffset + i] *= gain;
  }
}
```

**Fade Curves (PreviewPlayer.cpp:292-306):**

```cpp
float PreviewPlayer::calculateFadeGain(float normalizedPosition, const juce::String& curve) const {
  float gain = normalizedPosition; // Default: Linear

  if (curve == "EqualPower") {
    // Equal-power crossfade curve (sin/cos)
    gain = std::sin(normalizedPosition * juce::MathConstants<float>::halfPi);
  } else if (curve == "Exponential") {
    // Exponential curve (more dramatic)
    gain = normalizedPosition * normalizedPosition;
  }

  return std::clamp(gain, 0.0f, 1.0f);
}
```

**UI Wiring (ClipEditDialog.cpp:620-714):**

- Fade-in combo → setFades() on change
- Fade-out combo → setFades() on change
- Fade-in curve combo → setFades() on change
- Fade-out curve combo → setFades() on change

---

### 3. Transport Position Bar

**API Addition (WaveformDisplay.h:37-38):**

```cpp
void setPlayheadPosition(int64_t samplePosition);
```

**Rendering (WaveformDisplay.cpp:392-398):**

```cpp
// Draw playhead (transport position bar)
if (m_playheadPosition > 0) {
  float playheadX = bounds.getX() +
    (m_playheadPosition / static_cast<float>(m_waveformData.totalSamples)) * width;
  g.setColour(juce::Colours::white.withAlpha(0.8f));
  g.drawLine(playheadX, bounds.getY(), playheadX, bounds.getBottom(), 2.0f);
}
```

**Callback Wiring (ClipEditDialog.cpp:341-345):**

```cpp
m_previewPlayer->onPositionChanged = [this](int64_t samplePosition) {
  if (m_waveformDisplay) {
    m_waveformDisplay->setPlayheadPosition(samplePosition);
  }
};
```

**Update Rate:** Every 512 samples (~10ms at 48kHz)

---

### 4. Doubled Waveform Resolution

**Change (WaveformDisplay.cpp:241-248):**

```cpp
// Before: int targetWidth = getWidth();
int targetWidth = getWidth() * 2;  // 2x data points for fine edits
```

**Result:** Finer visual detail for precise trim editing regardless of zoom level

---

### 5. SDK Integration Infrastructure

**AudioEngine API (Audio/AudioEngine.h:79-90):**

```cpp
/// Update clip metadata (trim points, fades, etc.)
bool updateClipMetadata(int buttonIndex, int64_t trimInSamples, int64_t trimOutSamples,
                        double fadeInSeconds, double fadeOutSeconds,
                        const juce::String& fadeInCurve, const juce::String& fadeOutCurve);
```

**Stub Implementation (Audio/AudioEngine.cpp:165-192):**

```cpp
bool AudioEngine::updateClipMetadata(int buttonIndex, int64_t trimInSamples, int64_t trimOutSamples,
                                     double fadeInSeconds, double fadeOutSeconds,
                                     const juce::String& fadeInCurve, const juce::String& fadeOutCurve) {
  if (buttonIndex < 0 || buttonIndex >= 48) return false;

  auto handle = m_clipHandles[buttonIndex];
  if (handle == 0) {
    DBG("AudioEngine: Cannot update metadata - no clip loaded at button " << buttonIndex);
    return false;
  }

  DBG("AudioEngine: Updated clip metadata for button " << buttonIndex
      << " - Trim: [" << trimInSamples << ", " << trimOutSamples << "]"
      << ", Fade IN: " << fadeInSeconds << "s (" << fadeInCurve << ")"
      << ", Fade OUT: " << fadeOutSeconds << "s (" << fadeOutCurve << ")");

  // TODO (Week 7-8): Apply metadata to SDK's TransportController
  // Proposed SDK API:
  //   m_transportController->updateClipTrimPoints(handle, trimInSamples, trimOutSamples);
  //   m_transportController->updateClipFades(handle, fadeInSec, fadeOutSec, inCurve, outCurve);

  return true;
}
```

**MainComponent Integration (MainComponent.cpp:557-569):**

```cpp
// Apply trim/fade metadata to AudioEngine
if (m_audioEngine) {
  bool updated = m_audioEngine->updateClipMetadata(
      buttonIndex, clipData.trimInSamples, clipData.trimOutSamples, clipData.fadeInSeconds,
      clipData.fadeOutSeconds, juce::String(clipData.fadeInCurve), juce::String(clipData.fadeOutCurve));

  if (updated) {
    DBG("MainComponent: Applied trim/fade metadata to AudioEngine for button " << buttonIndex);
  }
}
```

---

## SDK Enhancement Required (Week 7-8)

**Current Gap:** TransportController has no API to update clip trim/fade after registration

**Proposed SDK API:**

```cpp
namespace orpheus {
  class ITransportController {
    virtual SessionGraphError updateClipTrimPoints(
      ClipHandle handle,
      int64_t trimInSamples,
      int64_t trimOutSamples) = 0;

    virtual SessionGraphError updateClipFades(
      ClipHandle handle,
      double fadeInSeconds,
      double fadeOutSeconds,
      const std::string& fadeInCurve,
      const std::string& fadeOutCurve) = 0;
  };
}
```

**Implementation Plan:**

1. Store clip metadata in `TransportController` playback state
2. Apply trim points in audio callback (start/stop sample positions)
3. Apply fade envelopes in audio callback (gain calculation)
4. Call SDK methods from `AudioEngine::updateClipMetadata()` (remove TODO)

**Timeline:** Week 7-8 (scheduled SDK enhancement)

**Documentation:** See `/docs/ORP/ORP074.md`, `/docs/SDK_TEAM_HANDOFF.md`, `/docs/SDK_SPRINT_SUMMARY.md`

---

## Testing

### Manual Test Results ✅

1. ✅ Load clip and open Edit Dialog
2. ✅ Set IN point using 'I' key while preview playing → Sets at current position
3. ✅ Set OUT point using 'O' key while preview playing → Sets at current position
4. ✅ Use < > buttons to nudge IN point → Instant preview restart
5. ✅ Change fade-in combo to 1.0s → Audible fade-in on preview playback
6. ✅ Change fade-out combo and fade curve → Audible effect
7. ✅ Observe white playhead moving during preview playback
8. ✅ Zoom waveform (2x, 4x, 8x) → 2x resolution maintained
9. ✅ Click OK → Metadata saved to SessionManager
10. ✅ Verify debug logs → AudioEngine logs metadata update
11. ⏳ Main clip button playback → Blocked on SDK API (Week 7-8)

### Build Status ✅

**Command:** `cmake --build build --target orpheus_clip_composer_app`
**Result:** Successful
**Warnings:** Only JUCE Font deprecation warnings (cosmetic, non-blocking)

---

## User-Facing Changes

### What Works Now (v0.2.0-alpha):

- ✅ IN < and > buttons restart preview for rapid audition
- ✅ I/O keyboard shortcuts set points at current playback position
- ✅ Preview playback starts from IN point (not sample 0)
- ✅ Waveform shows detailed audio with 2x resolution
- ✅ White playhead shows current preview position
- ✅ Fade times are audible in preview playback
- ✅ Different fade curves (Linear, Equal Power, Exponential) work correctly

### What Requires SDK Enhancement:

- ⏳ Main clip button playback respecting edited trim/fade settings
- **Workaround:** Reload clip to grid after editing (will apply on next load)
- **Priority:** Low (preview mode covers 90% use case)

---

## Files Modified

1. `ClipEditDialog.h` - Removed slider declarations
2. `ClipEditDialog.cpp` - Fixed I/O shortcuts, wired fade combos, removed sliders
3. `PreviewPlayer.h` - Added setFades() API and fade state
4. `PreviewPlayer.cpp` - Implemented fade processing with curves
5. `WaveformDisplay.h` - Added setPlayheadPosition() and playhead member
6. `WaveformDisplay.cpp` - Implemented playhead drawing and doubled resolution
7. `Audio/AudioEngine.h` - Added updateClipMetadata() declaration
8. `Audio/AudioEngine.cpp` - Implemented stub with SDK TODO
9. `MainComponent.cpp` - Wired OK button to call updateClipMetadata()

---

## Next Actions

**For v0.2.0-alpha Release:**

- [x] All preview mode features complete
- [x] Build successful
- [x] Manual testing passed
- [ ] Update CHANGELOG.md
- [ ] Update version number
- [ ] Create release candidate build

**For Week 7-8 (SDK Enhancement):**

- [ ] Implement TransportController trim/fade API
- [ ] Wire AudioEngine to SDK methods
- [ ] Test main playback with edited metadata
- [ ] Update acceptance criteria in OCC026

---

## References

[1] OCC034 - Waveform Rendering Implementation
[2] OCC035 - Edit Dialog Phases 2 & 3 Implementation
[3] OCC027 - API Contracts (AudioEngine interfaces)
[4] OCC029 - SDK Enhancement Recommendations
[5] ORP074 - SDK Enhancement Sprint: Clip Metadata Management
[6] SDK_TEAM_HANDOFF.md - Complete handoff documentation
[7] SDK_SPRINT_SUMMARY.md - Quick reference guide

---

**Status:** ✅ **COMPLETE** (Preview Mode)
**Next Milestone:** SDK API enhancement (Week 7-8)
