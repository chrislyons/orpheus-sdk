# OCC039 - Cue Buss Architecture for Edit Dialog Preview

**Version:** 1.0
**Date:** 2025-10-23
**Status:** Authoritative
**Author:** System (based on user feedback)

---

## Problem Statement

The current Edit Dialog preview system has fundamental architectural flaws:

1. **Separate audio streams** - PreviewPlayer creates its own audio device, resulting in TWO simultaneous audio outputs (main + preview)
2. **No playback continuity** - When editing a PLAYING clip, the preview doesn't inherit the current playback position
3. **Non-professional workflow** - Industry-standard soundboards (SpotOn, QLab) use "Cue Busses" that sum to main output

**Current behavior (WRONG):**

- Click button → Clip plays through main AudioEngine
- Right-click → Edit Dialog opens → PreviewPlayer creates SEPARATE audio device
- Result: TWO audio streams playing simultaneously, confusing user experience

**User's explicit feedback:**

> "Another important function is that when opening the edit dialog on a playing clip, that edit dialog should inherit the play position of the playing audio –– we have been doing this wrong by allowing overlapping/separate audio streams for main and preview indiscriminately. We should probably refer to this as a 'Cue Buss' (first of n). The Cue Buss(es) should be available for the edit dialog of all non-playing clips. Cue Buss(es) should default to summing to the main output unless routed elsewhere by the user."

---

## Cue Buss Design

### Core Concept

A **Cue Buss** is a virtual preview channel that:

1. Shares the same audio output as the main transport (sums to master)
2. Allows auditioning clips WITHOUT interrupting main playback
3. Can be routed independently for headphone monitoring (future feature)

### Rules

| Scenario                   | Behavior                                                           |
| -------------------------- | ------------------------------------------------------------------ |
| Edit a **PLAYING** clip    | Edit Dialog controls the **MAIN playback** (not a separate stream) |
| Edit a **STOPPED** clip    | Edit Dialog uses **Cue Buss 1** for preview                        |
| Multiple Edit Dialogs open | Each gets its own Cue Buss (Cue Buss 1, 2, 3, ...)                 |
| Cue Buss routing           | Default: Sum to main output. Future: Route to headphones           |

### Professional Workflow Example

**Broadcast operator scenario:**

1. Clip 1 is playing on main output (live on air)
2. Operator right-clicks Clip 5 → Edit Dialog opens
3. Operator adjusts Trim IN point and clicks Preview
4. Clip 5 plays through **Cue Buss 1** → Sums to main output (audible)
5. **Clip 1 continues playing uninterrupted**
6. Operator hears both (or routes Cue Buss to headphones in v2.0)

**Theater operator scenario:**

1. Clip 3 is playing (background music during scene)
2. Operator right-clicks **Clip 3** → Edit Dialog opens
3. Edit Dialog shows **current playback position** (inherited from main transport)
4. Operator adjusts Fade OUT time
5. Changes apply **immediately to the playing clip** (no separate preview needed)

---

## Architecture Changes

### Current Architecture (WRONG)

```
MainComponent
  └─ AudioEngine
      └─ TransportController (Main Transport)
          └─ Clip playback → CoreAudio Driver

ClipEditDialog
  └─ PreviewPlayer (SEPARATE AudioDevice!)
      └─ Separate CoreAudio Driver
      └─ Separate audio stream (overlaps with main!)
```

**Problems:**

- Two audio devices competing for hardware
- No synchronization between main and preview
- Preview doesn't inherit playback state

### New Architecture (CORRECT)

```
MainComponent
  └─ AudioEngine (owns ALL audio output)
      ├─ Main Transport (ClipHandle 1-960)
      │   └─ Playing clips → Routing Matrix → Master Output
      │
      └─ Cue Busses (ClipHandle 10001, 10002, 10003, ...)
          └─ Preview clips → Routing Matrix → Master Output (or Headphones)

ClipEditDialog
  ├─ IF clip is PLAYING:
  │   └─ Control Main Transport (no separate preview)
  │   └─ Inherit playback position from Main Transport
  │
  └─ IF clip is STOPPED:
      └─ Request Cue Buss from AudioEngine
      └─ Load clip into Cue Buss
      └─ Preview button → Start/Stop Cue Buss playback
```

---

## Implementation Plan

### Phase 1: Fix Immediate Crash (30 minutes)

**File:** `ClipEditDialog.h/cpp`

1. Implement proper destructor to clear PreviewPlayer callbacks before destruction
2. Prevents heap-use-after-free when dialog closes while preview is playing

**Code changes:**

```cpp
// ClipEditDialog.h
~ClipEditDialog() override; // Remove =default

// ClipEditDialog.cpp
ClipEditDialog::~ClipEditDialog() {
  // Clear all callbacks BEFORE PreviewPlayer is destroyed
  if (m_previewPlayer) {
    m_previewPlayer->onPositionChanged = nullptr;
    m_previewPlayer->onPlaybackStopped = nullptr;
  }
  // PreviewPlayer destructor will stop audio device safely
}
```

### Phase 2: Add Cue Buss Support to AudioEngine (2 hours)

**File:** `AudioEngine.h/cpp`

1. Add Cue Buss management:
   - `std::vector<orpheus::ClipHandle> m_cueBussHandles` (ClipHandles 10001+)
   - `orpheus::ClipHandle allocateCueBuss(const juce::String& filePath)`
   - `void releaseCueBuss(orpheus::ClipHandle handle)`
   - `bool startCueBuss(orpheus::ClipHandle handle)`
   - `bool stopCueBuss(orpheus::ClipHandle handle)`
   - `void updateCueBussMetadata(orpheus::ClipHandle handle, ...)`

2. Routing:
   - Cue Busses use same TransportController as main clips
   - Sum to main output by default (future: add routing matrix control)

**ClipHandle Allocation:**

- Main clips: 1-960 (48 buttons × 20 tabs future expansion)
- Cue Busses: 10001+ (dynamically allocated)

### Phase 3: Refactor ClipEditDialog to Use Cue Buss (3 hours)

**File:** `ClipEditDialog.h/cpp`

1. Replace PreviewPlayer with AudioEngine reference:

   ```cpp
   // OLD (WRONG):
   std::unique_ptr<PreviewPlayer> m_previewPlayer;

   // NEW (CORRECT):
   AudioEngine* m_audioEngine = nullptr; // Non-owning reference
   orpheus::ClipHandle m_cueBussHandle = 0; // 0 = not allocated
   bool m_isEditingPlayingClip = false;
   ```

2. Constructor changes:

   ```cpp
   ClipEditDialog(AudioEngine* audioEngine, int buttonIndex, bool isPlaying);
   ```

3. Behavior logic:

   ```cpp
   if (m_isEditingPlayingClip) {
     // Control main transport directly
     m_currentHandle = m_audioEngine->getClipHandle(buttonIndex);
     m_playheadPosition = m_audioEngine->getCurrentPosition(m_currentHandle);
   } else {
     // Allocate Cue Buss for preview
     m_cueBussHandle = m_audioEngine->allocateCueBuss(filePath);
   }
   ```

4. Destructor:
   ```cpp
   ~ClipEditDialog() {
     if (m_cueBussHandle != 0) {
       m_audioEngine->stopCueBuss(m_cueBussHandle);
       m_audioEngine->releaseCueBuss(m_cueBussHandle);
     }
   }
   ```

### Phase 4: Update MainComponent Integration (1 hour)

**File:** `MainComponent.cpp`

1. Pass AudioEngine reference and playback state to ClipEditDialog:

   ```cpp
   void MainComponent::onClipDoubleClicked(int buttonIndex) {
     bool isPlaying = m_audioEngine->isClipPlaying(buttonIndex);

     auto* dialog = new ClipEditDialog(m_audioEngine.get(), buttonIndex, isPlaying);
     dialog->setClipMetadata(metadata);
     dialog->onOkClicked = [this, buttonIndex](const ClipEditDialog::ClipMetadata& edited) {
       // Apply changes
       updateClipMetadata(buttonIndex, edited);
     };
     // ... show as modal dialog
   }
   ```

### Phase 5: Delete PreviewPlayer (30 minutes)

**Files:** `PreviewPlayer.h/cpp`

1. Once ClipEditDialog uses Cue Busses, delete PreviewPlayer entirely
2. Remove all references from CMakeLists.txt

---

## User Experience Improvements

### Before (Current - BROKEN)

1. User clicks Clip 5 → Plays through main
2. User right-clicks Clip 5 → Edit Dialog opens
3. User clicks Preview → **SECOND audio stream starts** (WRONG!)
4. User hears overlapping/phase-cancelling audio
5. Confusing, unprofessional behavior

### After (Cue Buss - CORRECT)

1. User clicks Clip 5 → Plays through main
2. User right-clicks **Clip 5** (while playing) → Edit Dialog opens
3. Edit Dialog shows **current playback position** (inherited from main)
4. User adjusts Fade OUT → **Changes apply to currently playing clip**
5. No separate preview needed (editing the live playback)

**OR:**

1. User right-clicks **Clip 8** (not playing) → Edit Dialog opens
2. User clicks Preview → Clip 8 plays through **Cue Buss 1**
3. Clip 8 preview sums to main output (audible alongside any other playing clips)
4. Professional workflow: Operator can audition while other clips play

---

## Success Criteria

- [ ] Edit Dialog no longer crashes on close (heap-use-after-free fixed)
- [ ] Editing a **PLAYING** clip shows current playback position
- [ ] Editing a **STOPPED** clip uses Cue Buss for preview
- [ ] Only ONE audio device is active (CoreAudio, not two!)
- [ ] Cue Buss preview sums to main output (not separate stream)
- [ ] PreviewPlayer.h/cpp deleted from codebase
- [ ] No audio glitches or phase cancellation
- [ ] Professional broadcast workflow validated by beta testers

---

## Future Enhancements (v2.0)

### Routing Matrix Integration

- Route Cue Buss 1 to Headphones (for silent auditioning)
- Route Cue Buss 2 to Secondary Output (for tech rehearsal)
- UI: "Cue Routing" dropdown in Edit Dialog (Main Output / Headphones / Output 3-8)

### Multiple Cue Busses

- Support up to 4 simultaneous Cue Busses (4 operators editing 4 clips)
- Visual indicator: "Cue 1" / "Cue 2" badge in Edit Dialog title bar
- Auto-allocation: First available Cue Buss assigned when Edit Dialog opens

### Scrubbing

- Drag playhead in waveform → Scrub audio (requires realtime pitch shifting)
- Rubber Band DSP integration (OCC028 recommendation)

---

## Related Documents

- **OCC021** - Product Vision (authoritative)
- **OCC023** - Component Architecture (5-layer model)
- **OCC027** - API Contracts (AudioEngine interface)
- **OCC029** - SDK Enhancement Recommendations (TransportController requirements)
- **OCC034** - Edit Dialog Implementation (Phase 1-3 complete, this replaces Phase 4)
- **ORP076** - Latency Audit (real-time performance requirements)

---

**CRITICAL:** This is not an optional enhancement. The current PreviewPlayer architecture is **fundamentally broken** and creates unprofessional user experience. Cue Buss implementation is **required for v0.2.0** before any beta testing.

**Estimated Implementation Time:** 7 hours (1 day of focused work)

**Priority:** **P0 - BLOCKER** for v0.2.0 release
