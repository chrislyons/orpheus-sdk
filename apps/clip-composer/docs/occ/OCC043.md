# OCC043 - v0.2.3-alpha Gap Analysis & Roadmap

**Date:** 2025-10-24
**Status:** Active Planning
**Type:** Gap Analysis & Implementation Roadmap
**Current Version:** v0.2.3-alpha (post-OCC042 bug fixes)
**Target Version:** v0.3.0-alpha (Feature Complete Preview)

---

## Executive Summary

OCC042 successfully fixed 5 of 6 critical Edit Dialog bugs. However, **actual audio functionality remains stubbed** — the application has a beautiful UI with comprehensive metadata management, but preview playback and clip triggering don't produce audio.

This document identifies all remaining gaps between current state and a functional audio application, prioritizes work, and provides implementation estimates.

**Critical Finding:** The Edit Dialog and session management are production-ready, but the **AudioEngine-to-SDK integration layer is incomplete**. Cue Buss methods log but don't call TransportController APIs.

---

## Current State Assessment

### ✅ What's Working (Verified)

**UI Layer (100% functional):**

- 48-button clip grid (6×8) with 8 tabs = 384 total clips
- Drag & drop audio file loading
- Keyboard shortcuts for all 48 buttons
- Transport controls (Stop All, Panic)
- ClipEditDialog with complete metadata editing:
  - Name, color, clip group assignment
  - Waveform visualization
  - Trim points (IN/OUT) with real-time markers
  - Fade In/Out times (0.0-3.0s) with curve selection
  - Loop toggle (state tracked)
- Session save/load (JSON format with full metadata)
- 3-line text wrapping, 20% larger fonts (Inter typeface)
- Drag-to-reorder clips (240ms hold time)
- Stop Others On Play mode (per-clip)

**Metadata Layer (100% functional):**

- ClipMetadata struct with all fields (name, color, group, trim, fades, loop)
- SessionManager save/load with full persistence
- Backward-compatible session loading
- Validation logic (IN < OUT enforcement)

**Build System (100% functional):**

- CMake integration with JUCE 8.0.4
- Debug build working (arm64 macOS)
- Clean build (zero compiler warnings, zero JUCE Font assertions)
- Launch script with PID tracking and log monitoring

### ❌ What's NOT Working (Critical Gaps)

**Audio Playback (0% functional):**

1. **Cue Buss preview playback** — Play/Stop buttons in Edit Dialog don't produce audio
   - `AudioEngine::startCueBuss()` logs but doesn't call SDK
   - `AudioEngine::stopCueBuss()` logs but doesn't call SDK
   - No audio file loaded into TransportController
   - No audio thread processing

2. **Clip button playback** — Clicking clip buttons doesn't trigger audio
   - `AudioEngine::startClip()` not wired to TransportController
   - No clip handle mapping (button index → SDK clip handle)
   - No audio file pre-loading

3. **Loop playback** — Loop toggle has no effect
   - SDK TransportController doesn't support loop restart logic
   - No loop_enabled, loop_in_samples, loop_out_samples in SDK ClipState
   - AudioEngine::setCueBussLoop() stub only

4. **Fade curves** — Fade In/Out times stored but not applied
   - No fade gain processing in audio thread
   - No fade curve implementation (Linear, Equal Power, Exponential)

5. **Real-time audio I/O** — No audio device integration
   - CoreAudio driver not initialized in AudioEngine
   - No IAudioCallback::processAudio() implementation
   - No audio thread running

**SDK Integration (30% functional):** 6. **TransportController not used** — SDK APIs exist but AudioEngine doesn't call them

- No clip loading (loadClipFromFile)
- No transport control (startClip, stopClip)
- No position tracking
- No callbacks wired

7. **Audio file reading incomplete** — IAudioFileReader not fully integrated
   - Files loaded for waveform display only
   - No pre-loading into TransportController
   - No sample-accurate positioning

**Missing Features (Planned for MVP):** 8. **No audio settings UI** — Sample rate, buffer size, device selection 9. **No performance monitoring** — CPU meter, latency display, buffer underruns 10. **No waveform caching** — Regenerated on each dialog open (performance issue) 11. **No stereo waveform** — Mono mix only, separate L/R channels TODO 12. **No interactive trim handles** — Slider-based only, drag handles TODO 13. **Phase 6: Professional transport bar** — Text buttons, not icons (deferred from OCC041)

---

## Gap Categorization by Priority

### P0 - Blocking (Must fix for basic audio playback)

**Gap #1: Wire AudioEngine to SDK TransportController** ⚠️ **CRITICAL**

- **Current:** AudioEngine methods log but don't call SDK
- **Required:** All AudioEngine methods must call corresponding TransportController APIs
- **Files:** `apps/clip-composer/Source/Audio/AudioEngine.cpp`
- **Estimate:** 2-3 hours
- **Blocks:** All audio playback functionality

**Gap #2: Initialize CoreAudio Driver**

- **Current:** No audio device running
- **Required:** Start CoreAudio driver, wire to AudioEngine::processAudio()
- **Files:** `apps/clip-composer/Source/Audio/AudioEngine.cpp`, `apps/clip-composer/Source/Main.cpp`
- **Estimate:** 1-2 hours
- **Blocks:** Real-time audio output

**Gap #3: Load Audio Files into TransportController**

- **Current:** Files read for waveform display only
- **Required:** Pre-load files into SDK when assigned to clip buttons
- **Files:** `apps/clip-composer/Source/Session/SessionManager.cpp`, `apps/clip-composer/Source/Audio/AudioEngine.cpp`
- **Estimate:** 2-3 hours
- **Blocks:** Clip triggering, preview playback

### P1 - High Priority (Needed for professional workflow)

**Gap #4: Implement Loop Playback in SDK**

- **Current:** Loop toggle tracked, but audio doesn't loop
- **Required:** Add loop restart logic to TransportController::processAudio()
- **Files:** `include/orpheus/transport_controller.h`, `src/core/transport/transport_controller.cpp`
- **Estimate:** 2-3 hours (SDK changes)
- **Blocks:** Loop audition in Edit Dialog

**Gap #5: Apply Fade Curves During Playback**

- **Current:** Fade times stored in metadata, not applied
- **Required:** Implement fade gain processing in SDK
- **Files:** `src/core/transport/transport_controller.cpp`, `src/core/dsp/fade_processor.cpp` (new)
- **Estimate:** 3-4 hours
- **Blocks:** Smooth clip entry/exit

**Gap #6: Implement Audio Settings UI**

- **Current:** Sample rate hardcoded to 48kHz, no device selection
- **Required:** Settings dialog for sample rate, buffer size, device
- **Files:** `apps/clip-composer/Source/UI/AudioSettingsDialog.cpp` (exists but not wired)
- **Estimate:** 2-3 hours
- **Blocks:** User control of audio configuration

### P2 - Medium Priority (UX improvements)

**Gap #7: Cache Waveform Data**

- **Current:** Waveform regenerated on each Edit Dialog open (50-200ms)
- **Required:** Cache waveform data per clip, instant dialog open
- **Files:** `apps/clip-composer/Source/UI/WaveformDisplay.cpp`, `apps/clip-composer/Source/Session/SessionManager.cpp`
- **Estimate:** 2-3 hours
- **Blocks:** Fast edit workflow

**Gap #8: Interactive Trim Handles**

- **Current:** Trim points set via sliders only
- **Required:** Drag trim handles directly on waveform
- **Files:** `apps/clip-composer/Source/UI/WaveformDisplay.cpp`
- **Estimate:** 3-4 hours
- **Blocks:** Intuitive trim editing (SpotOn parity)

**Gap #9: Stereo Waveform Display**

- **Current:** Mono mix only
- **Required:** Separate L/R channels in waveform
- **Files:** `apps/clip-composer/Source/UI/WaveformDisplay.cpp`
- **Estimate:** 2-3 hours
- **Blocks:** Stereo audio visualization

**Gap #10: Performance Monitor UI**

- **Current:** No CPU meter, no latency display
- **Required:** Real-time performance metrics in status bar
- **Files:** `apps/clip-composer/Source/UI/PerformanceMonitor.cpp` (new), `apps/clip-composer/Source/MainComponent.cpp`
- **Estimate:** 2-3 hours
- **Blocks:** Professional monitoring (broadcast requirement)

### P3 - Low Priority (Polish & future features)

**Gap #11: Professional Transport Bar (Phase 6)**

- **Current:** Text buttons ("Play", "Stop", "Loop")
- **Required:** Icon-based buttons (▶, ■, 🔁) with hover effects
- **Files:** `apps/clip-composer/Source/UI/ClipEditDialog.cpp`
- **Estimate:** 2-3 hours
- **Blocks:** Professional visual aesthetic (deferred from OCC041)

**Gap #12: Loop State Sync to Clip Buttons**

- **Current:** Loop state in metadata, not synced to clip button UI
- **Required:** Wire Edit Dialog loop toggle to ClipButton
- **Files:** `apps/clip-composer/Source/MainComponent.cpp`, `apps/clip-composer/Source/ClipGrid/ClipButton.cpp`
- **Estimate:** 30 minutes
- **Blocks:** Loop indicator on clip buttons

**Gap #13: Waveform Zoom/Pan**

- **Current:** Fixed resolution tied to component width
- **Required:** Zoom in/out, pan to specific region
- **Files:** `apps/clip-composer/Source/UI/WaveformDisplay.cpp`
- **Estimate:** 3-4 hours
- **Blocks:** Detailed trim editing (v1.0 feature)

---

## Implementation Roadmap

### Sprint 1: Core Audio Playback (P0 - Critical)

**Duration:** 6-8 hours
**Goal:** Get audio playing from clip buttons and Edit Dialog preview

**Tasks:**

1. **Wire AudioEngine to SDK** (Gap #1) - 2-3 hours
   - Replace stub implementations with TransportController calls
   - Implement clip handle mapping (button index → SDK handle)
   - Add error handling and logging

2. **Initialize CoreAudio Driver** (Gap #2) - 1-2 hours
   - Start audio device in Main.cpp
   - Wire AudioEngine::processAudio() to driver callback
   - Test audio thread running (sine wave test)

3. **Load Files into TransportController** (Gap #3) - 2-3 hours
   - Pre-load audio files when assigned to buttons
   - Update SessionManager to call SDK file loading APIs
   - Test clip triggering produces audio

**Acceptance Criteria:**

- [ ] Clicking clip button plays audio file
- [ ] Play button in Edit Dialog plays preview audio
- [ ] Stop button stops playback
- [ ] Audio outputs to CoreAudio device

**Deliverable:** v0.2.4-alpha - "First Audio Playback"

---

### Sprint 2: Loop & Fade Implementation (P1 - High)

**Duration:** 6-8 hours
**Goal:** Complete Edit Dialog audio features (loops, fades)

**Tasks:**

1. **Implement Loop Playback in SDK** (Gap #4) - 2-3 hours
   - Add loop_enabled, loop_in_samples, loop_out_samples to SDK ClipState
   - Implement loop restart logic in TransportController::processAudio()
   - Wire AudioEngine::setCueBussLoop() to SDK
   - Test loop playback in Edit Dialog

2. **Apply Fade Curves** (Gap #5) - 3-4 hours
   - Implement fade gain calculation (Linear, Equal Power, Exponential)
   - Add fade processing in TransportController
   - Wire fade metadata to SDK
   - Test fade-in/out audible

3. **Audio Settings UI** (Gap #6) - 2-3 hours
   - Wire AudioSettingsDialog to AudioEngine
   - Implement sample rate, buffer size, device selection
   - Save settings to preferences
   - Test settings persist across restarts

**Acceptance Criteria:**

- [ ] Loop toggle in Edit Dialog causes audio to loop
- [ ] Fade In/Out times audibly applied
- [ ] Audio settings dialog functional
- [ ] Settings persist in JSON config

**Deliverable:** v0.2.5-alpha - "Full Preview Playback"

---

### Sprint 3: UX Polish (P2 - Medium)

**Duration:** 8-10 hours
**Goal:** Professional editing workflow (fast, intuitive, visual)

**Tasks:**

1. **Cache Waveform Data** (Gap #7) - 2-3 hours
   - Store pre-computed waveform data in SessionManager
   - Load waveform from cache on Edit Dialog open
   - Invalidate cache on file change
   - Test instant dialog open (<50ms)

2. **Interactive Trim Handles** (Gap #8) - 3-4 hours
   - Implement drag behavior for IN/OUT handles on waveform
   - Add hover effects and cursor changes
   - Test trim editing feels intuitive

3. **Stereo Waveform** (Gap #9) - 2-3 hours
   - Split waveform display into L/R channels
   - Color-code channels (e.g., blue=L, red=R)
   - Test stereo files show correct separation

4. **Performance Monitor** (Gap #10) - 2-3 hours
   - Add CPU meter to status bar
   - Display audio latency and buffer size
   - Show underrun count
   - Test monitor updates in real-time

**Acceptance Criteria:**

- [ ] Edit Dialog opens instantly (<50ms)
- [ ] Trim handles draggable on waveform
- [ ] Stereo files show L/R channels
- [ ] CPU meter displays current load

**Deliverable:** v0.3.0-alpha - "Professional Workflow"

---

### Sprint 4: Visual Polish (P3 - Low Priority)

**Duration:** 4-6 hours
**Goal:** Broadcast-quality visual aesthetic

**Tasks:**

1. **Professional Transport Bar** (Gap #11) - 2-3 hours
   - Replace text buttons with icon-based buttons
   - Implement hover/press effects
   - Add transport scrubber (SpotOn-style)
   - Test visual comparison with LOOKBOOK references

2. **Loop State Sync** (Gap #12) - 30 minutes
   - Wire Edit Dialog loop state to ClipButton
   - Add loop indicator on clip button
   - Test loop toggle syncs both ways

3. **Waveform Zoom/Pan** (Gap #13) - 3-4 hours (OPTIONAL - v1.0 feature)
   - Add zoom slider or scroll-wheel zoom
   - Implement pan dragging
   - Test zoom into specific region

**Acceptance Criteria:**

- [ ] Transport buttons use professional icons
- [ ] Loop indicator on clip buttons
- [ ] (Optional) Waveform zoom/pan functional

**Deliverable:** v0.3.1-alpha - "Broadcast Ready UI"

---

## Timeline Summary

| Sprint                  | Priority | Duration   | Deliverable  | Cumulative Time |
| ----------------------- | -------- | ---------- | ------------ | --------------- |
| Sprint 1: Core Audio    | P0       | 6-8 hours  | v0.2.4-alpha | 6-8 hours       |
| Sprint 2: Loop & Fade   | P1       | 6-8 hours  | v0.2.5-alpha | 12-16 hours     |
| Sprint 3: UX Polish     | P2       | 8-10 hours | v0.3.0-alpha | 20-26 hours     |
| Sprint 4: Visual Polish | P3       | 4-6 hours  | v0.3.1-alpha | 24-32 hours     |

**Total Estimated Time:** 24-32 hours (3-4 weeks at 8 hours/week)

**Target Date for v0.3.0-alpha (Feature Complete Preview):** Mid-November 2025

---

## Risk Assessment

### High Risk Items

**Risk #1: SDK TransportController API may not support all OCC requirements**

- **Likelihood:** Medium
- **Impact:** High (blocks audio playback)
- **Mitigation:** Review SDK API surface early in Sprint 1, identify missing APIs
- **Contingency:** Extend Sprint 1 to implement missing SDK features

**Risk #2: CoreAudio driver initialization may fail**

- **Likelihood:** Low
- **Impact:** Critical (no audio output)
- **Mitigation:** Use SDK example code, test on multiple macOS versions
- **Contingency:** Fall back to dummy driver for development

**Risk #3: Fade processing may introduce audio artifacts**

- **Likelihood:** Medium
- **Impact:** Medium (quality issue)
- **Mitigation:** Use proven DSP algorithms (Equal Power curve standard)
- **Contingency:** Ship with Linear fade only, defer advanced curves to v1.0

### Medium Risk Items

**Risk #4: Waveform caching may consume excessive memory**

- **Likelihood:** Low
- **Impact:** Medium (performance issue)
- **Mitigation:** Limit cache size, evict least-recently-used waveforms
- **Contingency:** Disable caching, accept slower dialog open

**Risk #5: Loop playback may have glitches at loop point**

- **Likelihood:** Medium
- **Impact:** Medium (quality issue)
- **Mitigation:** Test with various audio files, ensure sample-accurate positioning
- **Contingency:** Add crossfade at loop point (1-5ms)

---

## Dependencies & Blockers

### External Dependencies

1. **Orpheus SDK APIs** - TransportController must support:
   - `loadClipFromFile(handle, path)`
   - `startClip(handle)` / `stopClip(handle)`
   - `setClipLoopEnabled(handle, enabled)`
   - `setClipFade(handle, fadeInSeconds, fadeOutSeconds, curves)`
   - `getClipPosition(handle)` for transport scrubber

2. **JUCE 8.0.4** - No changes needed (stable)

3. **CoreAudio Framework** - macOS system framework (always available)

### Internal Blockers

1. **Sprint 2 blocks Sprint 3** - Can't test waveform caching without audio playback working
2. **Sprint 3 blocks Sprint 4** - Professional transport bar needs functional playback to demo

**No critical blockers identified** - All work can proceed sequentially

---

## Success Metrics

### Sprint 1 Success (v0.2.4-alpha)

- [ ] Clip button plays audio when clicked
- [ ] Edit Dialog Play button plays preview audio
- [ ] Edit Dialog Stop button stops preview audio
- [ ] Audio outputs to system device (verified with headphones)
- [ ] No audio dropouts or glitches

### Sprint 2 Success (v0.2.5-alpha)

- [ ] Loop toggle causes audio to loop indefinitely
- [ ] Fade In/Out audibly applied (no clicks at start/end)
- [ ] Audio settings dialog functional (change sample rate, device)
- [ ] Settings persist across app restarts

### Sprint 3 Success (v0.3.0-alpha)

- [ ] Edit Dialog opens instantly (<50ms after waveform cached)
- [ ] Trim handles draggable on waveform (intuitive editing)
- [ ] Stereo files show separate L/R channels
- [ ] CPU meter shows real-time load (<10% with 4 clips playing)

### Sprint 4 Success (v0.3.1-alpha)

- [ ] Transport buttons use professional icons (not text)
- [ ] Loop indicator on clip buttons (visual sync)
- [ ] Visual aesthetic matches LOOKBOOK references (SpotOn, Pro Tools)

### Overall Success (v0.3.1-alpha - Beta Ready)

- [ ] All P0 and P1 gaps closed (audio playback fully functional)
- [ ] All P2 gaps closed (professional workflow)
- [ ] 90% of P3 gaps closed (visual polish)
- [ ] Zero regressions in existing functionality
- [ ] Ready for beta testing with 5-10 broadcast/theater users

---

## Out of Scope (v1.0 Features)

The following features are intentionally deferred to v1.0 (6-month milestone):

1. **Recording** - Capture audio directly into clip buttons
2. **Time-stretching** - Rubber Band library integration
3. **VST3/AU plugin hosting** - Effects processing
4. **Remote control via OSC** - iOS companion app
5. **Advanced routing** - 4 clip groups with aux sends
6. **Beat snapping** - Quantize fades/trims to bars/beats
7. **Crossfade preview** - Visualize Stop Others mode overlap
8. **Waveform overlay on clip buttons** - Mini waveform in button

**Rationale:** Focus v0.3.x on core playback and professional editing workflow. Add advanced features once foundation is solid.

---

## Documentation Updates Required

After each sprint:

1. **Update implementation_progress.md** - Mark sprints complete, update metrics
2. **Create sprint summary doc** (OCC044, OCC045, etc.) - Capture what was done
3. **Update CHANGELOG** - List all changes with issue numbers
4. **Update README** - Reflect new capabilities

After v0.3.0-alpha:

5. **Create OCC050 - Beta Testing Guide** - Instructions for beta testers
6. **Create OCC051 - Known Issues & Workarounds** - Document limitations
7. **Update OCC021 Product Vision** - Reflect progress toward MVP

---

## Next Steps

### Immediate Actions (Today)

1. **Approve roadmap** - Review this document, approve priority order
2. **Start Sprint 1** - Begin "Wire AudioEngine to SDK" (Gap #1)
3. **Set up branch** - Create `feature/core-audio-playback` branch

### This Week

1. **Complete Sprint 1** - v0.2.4-alpha with basic audio playback
2. **Test audio playback** - Verify clip triggering works
3. **Document Sprint 1** - Create OCC044 sprint summary

### Next Week

1. **Start Sprint 2** - Loop & fade implementation
2. **Complete Sprint 2** - v0.2.5-alpha with full preview playback
3. **Document Sprint 2** - Create OCC045 sprint summary

### By Mid-November

1. **Complete Sprint 3** - v0.3.0-alpha with professional workflow
2. **Begin beta testing** - 5-10 broadcast/theater users
3. **Collect feedback** - Document bugs and feature requests

---

## References

**Related Documents:**

- OCC041 - Edit Dialog Critical Bug Fixes Sprint (planning)
- OCC042 - Edit Dialog Bug Fixes Sprint Complete (execution report)
- OCC021 - Product Vision (authoritative)
- OCC026 - Milestone 1 MVP Definition (6-month plan)
- OCC029 - SDK Enhancement Recommendations (5 critical modules)

**SDK Documentation:**

- /ROADMAP.md - Milestone M2 (Real-Time Infrastructure)
- /ARCHITECTURE.md - SDK design rationale
- /docs/ADAPTERS.md - Available adapters and integration guides

**Code References:**

- `apps/clip-composer/Source/Audio/AudioEngine.cpp:235-246` - startCueBuss() stub (Gap #1)
- `apps/clip-composer/Source/UI/PreviewPlayer.cpp:105-118` - Loop playback TODO (Gap #4)
- `include/orpheus/transport_controller.h` - SDK API surface (needs review)

---

## Trigger Phrases

**To execute Sprint 1 (Core Audio Playback):**

```
"Execute Core Audio Playback sprint"
```

**To execute Sprint 2 (Loop & Fade):**

```
"Execute Loop and Fade sprint"
```

**To execute Sprint 3 (UX Polish):**

```
"Execute UX Polish sprint"
```

**To execute Sprint 4 (Visual Polish):**

```
"Execute Visual Polish sprint"
```

---

**Document Version:** 1.0
**Author:** Claude Code (Anthropic)
**Review Status:** Ready for Approval
**Estimated Total Duration:** 24-32 hours (3-4 weeks)
**Target Completion:** v0.3.0-alpha by Mid-November 2025

**Status:** ✅ Gap analysis complete, roadmap defined, ready for implementation
