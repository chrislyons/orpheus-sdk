name: Orpheus SDK CI Pipeline

on:
  push:
    branches: [main, develop, release/*]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.4'
  CMAKE_VERSION: '3.27.x'
  PUPPETEER_SKIP_DOWNLOAD: 'true'

jobs:
  # ============================================================================
  # C++ Build and Test (All Platforms)
  # ============================================================================
  cpp-build-test:
    name: C++ Build & Test (${{ matrix.os }}, ${{ matrix.build_type }})
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Debug, Release]
        include:
          - os: ubuntu-latest
            generator: 'Unix Makefiles'
            sanitizers: ON
          - os: windows-latest
            generator: 'Visual Studio 17 2022'
            sanitizers: OFF
          - os: macos-latest
            generator: 'Unix Makefiles'
            sanitizers: ON

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install libsndfile (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libsndfile1-dev

      - name: Install libsndfile (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          echo "Installing libsndfile via Homebrew..."
          brew install libsndfile

          # Verify installation
          if ! brew list libsndfile &>/dev/null; then
            echo "ERROR: libsndfile installation failed"
            exit 1
          fi

          echo "libsndfile installed successfully"
          pkg-config --modversion sndfile || echo "Note: pkg-config not finding sndfile (may use find_library fallback)"

      - name: Install libsndfile (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Installing libsndfile via vcpkg (using binary cache)..."

          # Use vcpkg binary caching to avoid SourceForge downloads (403 errors)
          # GitHub Actions provides pre-built binaries that bypass compilation
          vcpkg install libsndfile:x64-windows --binarysource="clear;nuget,GitHub,readwrite"

          # Verify installation
          if ! vcpkg list | grep -q libsndfile; then
            echo "ERROR: libsndfile installation failed"
            echo "Installed packages:"
            vcpkg list
            exit 1
          fi

          echo "✓ libsndfile installed successfully"
          vcpkg list | grep libsndfile

          # Set toolchain file for CMake
          echo "CMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
        shell: bash
        env:
          VCPKG_BINARY_SOURCES: 'clear;nuget,GitHub,readwrite'

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -G "${{ matrix.generator }}" \
            ${{ matrix.os == 'windows-latest' && env.CMAKE_TOOLCHAIN_FILE && format('-DCMAKE_TOOLCHAIN_FILE={0}', env.CMAKE_TOOLCHAIN_FILE) || '' }} \
            ${{ matrix.build_type == 'Debug' && matrix.sanitizers == 'ON' && '-DORP_ENABLE_SANITIZERS=ON' || '' }} 2>&1 | tee cmake_output.log
        shell: bash

      - name: Verify libsndfile detection
        run: |
          echo "Checking CMake output for libsndfile detection..."

          if grep -q "✓ libsndfile FOUND" cmake_output.log; then
            echo "✓ SUCCESS: libsndfile detected - audio file reading enabled"
          elif grep -q "✗ libsndfile NOT FOUND" cmake_output.log; then
            echo "❌ FAILURE: libsndfile NOT detected - using stub implementation"
            echo ""
            echo "This will cause 8 transport tests to fail with NotReady error:"
            echo "  - fade_processing_test"
            echo "  - out_point_enforcement_test"
            echo "  - multi_clip_stress_test"
            echo "  - clip_gain_test"
            echo "  - clip_loop_test"
            echo "  - clip_metadata_test"
            echo "  - clip_restart_test"
            echo "  - clip_seek_test"
            echo ""
            echo "Debug info:"
            echo "Platform: ${{ matrix.os }}"
            echo "CMake toolchain file: ${CMAKE_TOOLCHAIN_FILE:-not set}"
            grep -i "sndfile" cmake_output.log || echo "No sndfile mentions in CMake output"
            exit 1
          else
            echo "⚠ WARNING: Could not determine libsndfile detection status"
            echo "Checking for warning messages..."
            grep -i "libsndfile not found" cmake_output.log || echo "No explicit 'not found' message"
            exit 1
          fi
        shell: bash

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} --parallel
        timeout-minutes: 10

      - name: Test
        run: ctest --test-dir build --output-on-failure --build-config ${{ matrix.build_type }}
        timeout-minutes: 10

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/CTestCostData.txt
          if-no-files-found: ignore

  # ============================================================================
  # C++ Linting
  # ============================================================================
  cpp-lint:
    name: C++ Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format-14

      - name: Run clang-format
        run: |
          find src include -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | \
          xargs clang-format-14 --dry-run --Werror

      - name: Lint Windows includes
        run: |
          python3 - <<'PY'
          import pathlib
          import sys

          ROOT = pathlib.Path('.')
          violations = []
          for path in ROOT.rglob('*'):
            if not path.is_file():
              continue
            try:
              relative = path.relative_to(ROOT)
            except ValueError:
              continue
            parts = set(relative.parts)
            if 'backup' in parts:
              continue
            if path.suffix.lower() not in {
                '.c', '.cc', '.cxx', '.cpp', '.h', '.hh', '.hpp', '.hxx', '.inl'
            }:
              continue
            try:
              text = path.read_text(encoding='utf-8')
            except UnicodeDecodeError:
              continue
            lines = text.splitlines()
            for index, line in enumerate(lines):
              if '#include <windows.h>' not in line:
                continue
              prior = lines[:index]
              if not any('#define NOMINMAX' in candidate for candidate in prior):
                violations.append(f"{path}:{index + 1}")

          if violations:
            print('Found #include <windows.h> without prior #define NOMINMAX:')
            for violation in violations:
              print(f"  {violation}")
            sys.exit(1)
          PY

      - name: Check for binary artifacts
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          git fetch --depth=1 origin "${{ github.base_ref }}"
          mapfile -t added < <(git diff --name-only --diff-filter=A "origin/${{ github.base_ref }}"...HEAD)
          if [ ${#added[@]} -eq 0 ]; then
            echo "No newly added files; performing repository scan instead."
          fi
          declare -a banned=(".wav" ".dll" ".exe" ".a" ".so" ".dylib" ".lib")
          declare -a violations=()
          declare -A seen=()
          for file in "${added[@]}"; do
            lower=$(printf '%s' "$file" | tr '[:upper:]' '[:lower:]')
            for ext in "${banned[@]}"; do
              if [[ "$lower" == *"${ext}" ]]; then
                if [[ -z "${seen[$file]:-}" ]]; then
                  violations+=("$file")
                  seen["$file"]=1
                fi
                break
              fi
            done
          done
          if [ ${#violations[@]} -eq 0 ]; then
            mapfile -t tracked < <(git ls-files)
            for file in "${tracked[@]}"; do
              lower=$(printf '%s' "$file" | tr '[:upper:]' '[:lower:]')
              for ext in "${banned[@]}"; do
                if [[ "$lower" == *"${ext}" ]]; then
                  if [[ -z "${seen[$file]:-}" ]]; then
                    violations+=("$file")
                    seen["$file"]=1
                  fi
                  break
                fi
              done
            done
          fi
          if [ ${#violations[@]} -ne 0 ]; then
            echo "Binary artifacts detected by CI guardrails:"
            for file in "${violations[@]}"; do
              echo "  $file"
            done
            echo "Please store binary fixtures as text (e.g. base64) instead of committing them directly."
            exit 1
          fi

  # ============================================================================
  # NOTE: TypeScript/packages-related jobs removed as packages/ archived
  # See docs/DECISION_PACKAGES.md for rationale (C++ SDK focus)
  # ============================================================================

  # ============================================================================
  # Status Check (Required for Branch Protection)
  # ============================================================================
  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs:
      [
        cpp-build-test,
        cpp-lint,
      ]
    if: always()

    steps:
      - name: Check all jobs succeeded
        run: |
          if [[ "${{ needs.cpp-build-test.result }}" == "failure" ]] || [[ "${{ needs.cpp-build-test.result }}" == "cancelled" ]] || \
             [[ "${{ needs.cpp-lint.result }}" == "failure" ]] || [[ "${{ needs.cpp-lint.result }}" == "cancelled" ]]; then
            echo "❌ One or more jobs failed"
            echo "cpp-build-test: ${{ needs.cpp-build-test.result }}"
            echo "cpp-lint: ${{ needs.cpp-lint.result }}"
            exit 1
          fi
          echo "✅ All CI checks passed"
